@page "/remind-password"

@inject HttpClient Http

@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@using Serilog
@using SdWP.Frontend.Enum
@using SdWP.Frontend.Functions


@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-danger" role="alert">
        @message
    </div>
}

<section class="py-3 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5 col-xxl-4">
                <div class="card border border-light-subtle rounded-3">
                    <div class="card-body p-3 p-md-4 p-xl-5">
                        <h2 class="fs-6 fw-normal text-center text-secondary mb-4">Send link to reset </h2>
                        <EditForm Model="model" OnValidSubmit="HandleRemindPassword">
                            <DataAnnotationsValidator />
                            <ValidationSummary />
                            <div class="row gy-2 overflow-hidden">
                                <div class="col-12">
                                    <div class="form-floating mb-3">
                                        <InputText id="email" @bind-Value="model.Email" class="form-control" placeholder="name@example.com" />
                                        <label for="email">Email</label>
                                        <ValidationMessage For="@(() => model.Email)" />
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-grid my-3">
                                        <button class="btn btn-primary btn-lg" type="submit" disabled="@isLoading">
                                            @if (isLoading)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                            }
                                            Wyślij link
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@code {
    private string? message = string.Empty;
    private ResetPasswordRequest model = new();
    private bool isLoading = false;

    public class ResetPasswordRequest
    {
        [Required(ErrorMessage = "Email address is required.")]
        [EmailAddress(ErrorMessage = "Invalid email address format.")]
        public string Email { get; set; }
    }

    private async Task HandleRemindPassword()
    {
        isLoading = true;
        try
        {
            var response = await Http.PostAsJsonAsync("api/remind-password", model);

            if (response.IsSuccessStatusCode)
            {
                message = "Sent reset email to your mailbox";
            }
            else
            {
                var errors = await response.Content.ReadAsStringAsync();
                message = $"Error: {errors}";
            }
        }
        catch (Exception e)
        {
            message = $"Error: {e.Message}";
            await SendLogToDatabase.SendLogAsync(
                $"Error during ResetPassword {message}",
                e.StackTrace ?? "Unknow",
                e.Source ?? "Client/Login/HandleRemindPassword",
                TypeOfLog.Error);
        }
        isLoading = false;
    }

}
